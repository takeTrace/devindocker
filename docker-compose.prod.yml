version: '3.8'

services:
  nginx:
    extends:
      file: docker-compose.base.yml
      service: nginx
    ports:
      - "8080:80"
  redis:
    extends:
      file: docker-compose.base.yml
      service: redis
  mongodb:
    container_name: mongodb
    extends:
      file: docker-compose.base.yml
      service: mongodb
    user: root
    volumes:
      - mongo-db:/data/db

  devindocker:
    deploy:
      replicas: 8
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 3
        window: 100s
      rollback_config:
        parallelism: 2
        delay: 3s
      update_config:
        parallelism: 2
        delay: 2s

    extends:
      file: docker-compose.base.yml
      service: devindocker
    image: taketrace00/devindocker
    build:
      context: .
      args:
        NODE_ENV: production
    env_file: .env
    command: npm run start

volumes:
  mongo-db:
    name: 'mongo-db'
